<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Find Your MP</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 40px auto;
        }
        input, button, select, textarea {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
        }
        #result {
            display: none;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<h2>Find Your MP</h2>

<input id="postcodeInput" type="text" placeholder="Enter your postcode">
<button id="searchBtn">Find MP</button>

<div id="result">
    <select id="mpSelect"></select>

    <textarea id="emailBody" rows="6" placeholder="Write your message"></textarea>
    <button id="sendBtn">Email MP</button>
</div>

<script>
let mpData = [];

// Load CSV
fetch("mp_pcd_sector.csv")
    .then(res => res.text())
    .then(csv => {
        Papa.parse(csv, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
                mpData = results.data;
                console.log("MP data loaded:", mpData.length);
                console.log(mpData[0]); // log first row to check columns
            }
        });
    });

// Convert postcode to sector
function extractSector(postcode) {
    const clean = postcode.toUpperCase().replace(/\s+/g, "");

    // Full postcode e.g. PE280LF
    const full = clean.match(/^([A-Z]{1,2}\d{1,2})(\d)[A-Z]{2}$/);
    if (full) return `${full[1]} ${full[2]}`;

    // Sector e.g. PE280 or PE28
    const sector = clean.match(/^([A-Z]{1,2}\d{1,2})(\d?)$/);
    if (sector) return sector[2] ? `${sector[1]} ${sector[2]}` : sector[1];

    return "";
}

// Find MP
document.getElementById("searchBtn").addEventListener("click", () => {
    const input = document.getElementById("postcodeInput").value.trim();
    if (!input) return;

    const sector = extractSector(input);
    console.log("Searching for sector:", sector);

    const matches = mpData.filter(row => {
        const csvSector = row["Postcode Sector"] || "";
        return csvSector.toUpperCase().startsWith(sector);
    });

    const select = document.getElementById("mpSelect");
    select.innerHTML = "";

    if (matches.length === 0) {
        select.innerHTML = "<option>No MP found for this postcode</option>";
    } else {
        matches.forEach(row => {
            const opt = document.createElement("option");
            opt.value = row["Email"]; // store email for mailto
            opt.textContent = `${row["Constituency"]} — ${row["NameDisplay"]}`;
            select.appendChild(opt);
        });
    }

    document.getElementById("result").style.display = "block";
});

// Generate email
document.getElementById("sendBtn").addEventListener("click", () => {
    const select = document.getElementById("mpSelect");
    const body = document.getElementById("emailBody").value.trim();

    if (!select.value || !body) return;

    const mpName = select.options[select.selectedIndex]
        .text.split("—")[1]
        .trim();

    const mpEmail = select.value;

    const subject = "Concern from a constituent";
    const emailBody = `Dear ${mpName},\n\n${body}\n\nYours sincerely,`;

    window.location.href =
        `mailto:${encodeURIComponent(mpEmail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
});
</script>

</body>
</html>
