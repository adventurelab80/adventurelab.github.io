<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Find Your MP</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 40px auto;
        }
        input, button, select, textarea {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
        }
        #result {
            display: none;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<h2>Find Your MP</h2>

<input id="postcodeInput" type="text" placeholder="Enter your postcode">
<button id="searchBtn">Find MP</button>

<div id="result">
    <select id="mpSelect"></select>
    <textarea id="emailBody" rows="6" placeholder="Write your message"></textarea>
    <button id="sendBtn">Email MP</button>
</div>

<script>
let mpData = [];

// Load CSV with trimmed headers & values
fetch("mp_pcd_sector.csv")
    .then(res => res.text())
    .then(csv => {
        Papa.parse(csv, {
            header: true,
            skipEmptyLines: true,
            trimHeaders: true,
            complete: (results) => {
                // Trim all values in each row to remove hidden spaces
                mpData = results.data.map(row => {
                    const trimmedRow = {};
                    for (let key in row) {
                        if (row.hasOwnProperty(key)) {
                            trimmedRow[key.trim()] = (row[key] || "").trim();
                        }
                    }
                    return trimmedRow;
                });

                console.log("MP data loaded:", mpData.length);
                console.log("Sample row:", mpData[0]);
            }
        });
    });

// Normalize postcode to sector (AA1 1)
function normalizePostcode(input) {
    if (!input) return "";
    const clean = input.toUpperCase().replace(/\s+/g, "");

    // Match outward + first inward digit (sector)
    const match = clean.match(/^([A-Z]{1,2}\d{1,2})(\d)/);
    if (match) return `${match[1]} ${match[2]}`;

    // Fallback if only outward code (e.g., CB7)
    const fallback = clean.match(/^([A-Z]{1,2}\d{1,2})$/);
    if (fallback) return fallback[1];

    return "";
}

// Search for MP
document.getElementById("searchBtn").addEventListener("click", () => {
    const input = document.getElementById("postcodeInput").value.trim();
    if (!input) return;

    const sector = normalizePostcode(input);
    console.log("Searching for sector:", sector);

    const matches = mpData.filter(row => {
        const csvSector = (row["Postcode Sector"] || "").toUpperCase();
        return csvSector.startsWith(sector);
    });

    console.log("Matches found:", matches.length, matches);

    const select = document.getElementById("mpSelect");
    select.innerHTML = "";

    if (matches.length === 0) {
        select.innerHTML = "<option>No MP found for this postcode</option>";
    } else {
        matches.forEach(row => {
            const opt = document.createElement("option");
            opt.value = row["Email"];
            opt.textContent = `${row["Constituency"]} — ${row["NameDisplay"]}`;
            select.appendChild(opt);
        });
    }

    document.getElementById("result").style.display = "block";
});

// Generate email
document.getElementById("sendBtn").addEventListener("click", () => {
    const select = document.getElementById("mpSelect");
    const body = document.getElementById("emailBody").value.trim();

    if (!select.value || !body) return;

    const mpName = select.options[select.selectedIndex]
        .text.split("—")[1]
        .trim();

    const mpEmail = select.value;

    const subject = "Concern from a constituent";
    const emailBody = `Dear ${mpName},\n\n${body}\n\nYours sincerely,`;

    window.location.href =
        `mailto:${encodeURIComponent(mpEmail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
});
</script>

</body>
</html>
